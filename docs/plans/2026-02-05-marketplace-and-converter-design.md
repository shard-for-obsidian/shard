# Shard Community Marketplace & Legacy Plugin Converter Design

**Date:** 2026-02-05
**Status:** Approved

## Overview

This design covers two interconnected features:
1. **GitHub-hosted community marketplace** for discovering Shard plugins
2. **Legacy Obsidian plugin converter** for migrating existing community plugins to Shard format

These features work together to build a plugin ecosystem - the converter provides content while the marketplace enables discovery.

## Architecture Overview

The marketplace system consists of three main components:

### 1. Marketplace Repository (GitHub)
A public GitHub repository serving as a collaborative plugin registry:
- `plugins/` directory containing one `{plugin-id}.md` file per plugin
- Each markdown file has YAML frontmatter with metadata (id, name, author, description, repo, ghcr-reference)
- Markdown body contains the plugin's README fetched from the original repository
- Root `plugins.json` file auto-generated by GitHub Actions on every push
- Basic `README.md` explaining the submission process

### 2. CLI Tooling (shard-cli)
Two new commands extending the existing CLI:
- `shard convert <plugin-id>` - Converts legacy Obsidian plugins to Shard format
- `shard marketplace register <ghcr-reference>` - Generates marketplace listing files

### 3. Installer Integration (shard-installer)
The Obsidian plugin fetches `plugins.json` directly from the marketplace repository's raw GitHub URL, enabling plugin browsing and installation.

### Key Architectural Change
All Shard plugins (new and converted) will store `manifest.json` as the OCI image config rather than as a layer. This is a breaking change affecting the entire stack.

## OCI Manifest Format Changes

### Current Format (deprecated)
- Plugin files (main.js, manifest.json, styles.css) all stored as OCI layers
- Manifest.json extracted from layers during installation

### New Format
- `manifest.json` content stored in OCI image config blob
- Only plugin code/assets (main.js, styles.css, etc.) stored as layers
- Config field contains the full plugin manifest JSON

### Implementation Changes Required

**shard-lib updates:**
- Modify `pushPlugin()` to accept manifest object separately
- Store manifest as config blob instead of layer
- Update `pullPlugin()` to read manifest from config field
- Update type definitions to reflect new structure

**shard-cli updates:**
- Modify push command to extract manifest.json before layer creation
- Pass manifest separately to lib's `pushPlugin()`
- Ensure converted plugins follow new format

**shard-installer updates:**
- Read manifest from OCI config during plugin fetch
- Remove manifest.json extraction from layers
- Update installation flow to work with new structure

This keeps the plugin manifest semantically separate from code artifacts and makes it easily accessible without unpacking layers.

## Legacy Plugin Converter

### Command Signature
```bash
shard convert <plugin-id> [options]
```

### Options
- `--version <version>` - Convert specific version (default: latest release)
- `--output-dir <path>` - Save locally instead of pushing to GHCR
- Standard push options (--registry, --repository, etc.) when not using --output-dir

### Conversion Workflow

1. **Fetch community plugin list** - Download and cache `community-plugins.json` from obsidian-releases repo (`https://raw.githubusercontent.com/obsidianmd/obsidian-releases/refs/heads/master/community-plugins.json`)
2. **Lookup plugin** - Find plugin by ID, extract repo URL
3. **Fetch release** - Query GitHub API for releases, select version (latest or specified)
4. **Download assets** - Download release assets to temp directory (typically main.js, manifest.json, styles.css)
5. **Validate files** - Ensure manifest.json and main.js exist (minimum required files)
6. **Package as Shard plugin** - Extract manifest.json, package remaining files as OCI layers with manifest as config
7. **Add OCI annotations** - Add `org.obsidian.plugin.repo` annotation with GitHub repo URL from community list
8. **Output** - Either push to GHCR (default) or save to local directory (--output-dir)
9. **Cleanup** - Remove temp directory

### Error Handling
- Plugin ID not found in community list
- No releases available on GitHub repo
- Missing required files (manifest.json, main.js)
- GitHub API rate limiting
- GHCR authentication failures

## Marketplace Registration

### Command Signature
```bash
shard marketplace register <ghcr-reference>
```

### Arguments
- `<ghcr-reference>` - Full GHCR reference (e.g., `ghcr.io/owner/plugin-name:tag`)

### Registration Workflow

1. **Pull OCI manifest** - Fetch the OCI image manifest from GHCR to access config
2. **Extract plugin manifest** - Read manifest.json from OCI config field
3. **Parse metadata** - Extract id, name, author, description, version from plugin manifest
4. **Read repo annotation** - Get original repository URL from `org.obsidian.plugin.repo` annotation
5. **Fetch README** - Download README.md from the repository if it exists
6. **Generate markdown file** - Create `{plugin-id}.md` with:
   - YAML frontmatter: id, name, author, description, repo, ghcr-reference
   - Body: README content (or empty if no README found)
7. **Save locally** - Write file to current directory

### Output
- Markdown file ready for manual PR submission to marketplace repository
- Console message with next steps (fork marketplace repo, commit file, open PR)

### Error Handling
- Missing repo annotation - Fail with clear message
- GHCR image not found - Validate reference exists before attempting registration
- No README in repo - Generate markdown with frontmatter only, warn user
- README fetch fails - Continue with empty body, log warning
- Invalid manifest data - Validate required fields (id, name, author, description) exist

## Marketplace Repository Structure

### Repository Layout
```
shard-marketplace/
├── .github/
│   └── workflows/
│       └── generate-index.yml
├── plugins/
│   ├── obsidian-git.md
│   ├── nldates-obsidian.md
│   └── ... (one file per plugin)
├── plugins.json (generated, not committed)
├── .gitignore (ignore plugins.json)
└── README.md
```

### Plugin Markdown Format
```markdown
---
id: obsidian-git
name: Git
author: Vinzent, (Denis Olehov)
description: Integrate Git version control with automatic backup and other advanced features.
repo: Vinzent03/obsidian-git
ghcr: ghcr.io/username/obsidian-git:latest
---

[README content from original repo]
```

### GitHub Action
**Workflow:** `generate-index.yml`
- Triggers on push to main branch
- Scans `plugins/` directory
- Parses YAML frontmatter from each .md file
- Generates `plugins.json` as array of plugin objects
- Commits and pushes `plugins.json` back to repo

### Generated plugins.json Format
```json
[
  {
    "id": "obsidian-git",
    "name": "Git",
    "author": "Vinzent, (Denis Olehov)",
    "description": "Integrate Git version control...",
    "repo": "Vinzent03/obsidian-git",
    "ghcr": "ghcr.io/username/obsidian-git:latest"
  }
]
```

### Submission Process
- Manual PR submission initially
- Authors fork marketplace repo, add plugin markdown, open PR
- Maintainer reviews and merges
- GitHub Action regenerates plugins.json automatically

## Installer Integration

### Marketplace Consumption

**Configuration:**
- Add marketplace URL setting to shard-installer settings
- Default: `https://raw.githubusercontent.com/[owner]/shard-marketplace/main/plugins.json`
- Allows users to point to alternative/private marketplaces

**Fetching Plugins:**
- Installer fetches `plugins.json` on demand (with caching)
- Parse JSON into plugin listing
- Display in browsable UI within Obsidian settings

**Caching Strategy:**
- Cache `plugins.json` locally with TTL (e.g., 1 hour)
- Add manual "Refresh marketplace" button
- Cache bust on version updates

**Installation Flow:**
1. User browses marketplace in installer settings
2. Selects plugin, clicks install
3. Installer uses `ghcr` reference from marketplace entry
4. Pulls OCI image from GHCR (using updated lib with config-based manifest)
5. Extracts manifest from OCI config
6. Extracts plugin files from layers
7. Installs to Obsidian plugins directory

**UI Considerations:**
- Show plugin name, author, description from marketplace
- Display original repo link for users to learn more
- Indicate if plugin is already installed
- Show installed vs available versions

### Error Handling
- **plugins.json fetch fails** - Use cached version if available, show offline indicator
- **Malformed JSON** - Log error, clear cache, prompt manual refresh
- **GHCR pull fails** - Show specific error (auth, network, not found)
- **Invalid OCI format** - Detect missing config manifest, show helpful error

## Testing Strategy

### Unit Tests

**shard-lib:**
- Test OCI config serialization/deserialization with manifest.json
- Test layer creation excluding manifest.json
- Test pull/push with new format
- Mock GHCR interactions

**shard-cli:**
- Test community-plugins.json parsing and caching
- Test GitHub release fetching and version selection
- Test conversion with various plugin structures (with/without styles.css, etc.)
- Test marketplace markdown generation
- Mock GitHub API and GHCR interactions

**shard-installer:**
- Test plugins.json fetching and parsing
- Test cache TTL behavior
- Test manifest extraction from OCI config
- Mock network requests

### Integration Tests

**End-to-end conversion flow:**
1. Convert a known community plugin (e.g., "calendar")
2. Push to test GHCR repository
3. Generate marketplace listing
4. Verify OCI structure (config contains manifest, layers contain code)

**End-to-end installation flow:**
1. Set up test marketplace with plugins.json
2. Configure installer to use test marketplace
3. Install plugin from marketplace
4. Verify plugin files extracted correctly

### Manual Testing
- Test with various community plugins (different file structures)
- Test GitHub rate limiting behavior
- Test marketplace PR workflow
- Test installer UI with real marketplace data

## Implementation Order

### Phase 1: Foundation (OCI format change)
1. Update shard-lib to support manifest-in-config format
2. Update shard-cli push command to use new format
3. Update shard-installer to read manifest from config
4. Test with manual plugin creation

### Phase 2: Legacy Converter
1. Implement community-plugins.json fetching and caching
2. Implement GitHub release fetching
3. Implement conversion logic with OCI annotations
4. Add --version and --output-dir flags
5. Test with various community plugins

### Phase 3: Marketplace Infrastructure
1. Create marketplace repository structure
2. Implement GitHub Action for plugins.json generation
3. Write README with submission guidelines
4. Test action with sample plugin markdown files

### Phase 4: Marketplace Registration
1. Implement `shard marketplace register` command
2. Add repo annotation reading from OCI manifest
3. Implement README fetching
4. Test markdown generation

### Phase 5: Installer Integration
1. Add marketplace URL configuration
2. Implement plugins.json fetching and caching
3. Update UI to display marketplace plugins
4. Test installation flow end-to-end

## Breaking Changes

**OCI Format Migration:**
- Existing Shard plugins need re-pushing with new format
- Update all examples and documentation
- No backward compatibility - clean break for simpler implementation

## Future Enhancements

- Automated PR submission for marketplace registration
- Plugin screenshots and additional metadata
- Version compatibility checking
- Plugin update notifications
- Search and filtering in marketplace UI
- Plugin categories/tags
- Download statistics
- Plugin verification/signing integration
